# <font size=9>实验报告</font>
### <font size=6> 22371437 张智威</font>

### <font color=#CD5C5C face='黑体' strong=true size=6> Test1-ORM.PY</font>
<font size=4 face='楷体'> 
&ensp; &ensp; &ensp;首先对数据库中的各个关系与 Test1-ORM.PY 中的对象进行了一一对应，同时设置类的属性与关系的列的对应关系，按照题目要求设置各表的主键，唯一约束，外键等等。同时通过 relationship() 函数建立 .py 文件中对象之间的关系，如下图：<br><br>

<div align=center><img src=image-1.png></div><hr>

&ensp; &ensp; &ensp;同时为每一个类设置了一个 ```to_dict(self)``` 方法，便于获取一个对象对应的属性信息，即对应表中元组的属性信息，下面为 dept_emp 表的例子：<br>

<div align=center><img src=image-2.png></div><hr>

&ensp; &ensp; &ensp;对于增加触发器的处理，初始时由于没看到后面的sql语句，因此尝试了在 .py 中对对象添加了触发器，而不是通过sql语句加入到数据库中，如下图：<br>

<div align=center><img src=image-3.png></div><hr>

&ensp; &ensp; &ensp;在发现了有用于增加触发器的sql语句后，通过编写sql语句，使得在创建表单的时候，增加触发器到所需关系中，实现题目要求的同步添加数据和同步删除数据功能，分别在添加数据和删除数据后接着更新关联的表的数据，如下图：<br>

<div align=center><img src=image-4.png></div><hr>

&ensp; &ensp; &ensp;随后通过代码中本身提供的读取 .csv 文件的函数，分别读取各个关系表的数据，并通过不同的列名读取不同列的数据，通过 `session.bulk_save_objects()` 函数以及建立的关系表和对象的联系，全部插入相对应的关系表中，完成数据的注入。

### <font color=#CD5C5C face='黑体' strong=true size=6> Test2-RESTful.PY</font>
&ensp; &ensp; &ensp;在 Test2-RESTful.PY 中要分别对insert，delete，update，select功能实现Restful接口，接下来一个一个分析具体实现方式：<br><br>
<font color=#39a3d1 size=6 face='黑体' strong=true>*1.insert*</font><br>
&ensp; &ensp; &ensp;本身代码中给出，不再赘述。<br><br>
<font color=#39a3d1 size=6 face='黑体' strong=true>*2.update*</font><br>
&ensp; &ensp; &ensp;在读入 request.json 文件内容（即传入的data）后，python自动为我们通过dict类型进行存储，于是我们将key（即列名）与 values（即数据）分别用两个列表进行存储，随后通过执行 sql 语句获取对应表的主键名，存入primary_key_columns中：

<div align=center><img src=image-5.png></div><hr>
&ensp; &ensp; &ensp;随后对进行数据更新的 where 语句进行拼接，查找到与主键名相同的 key 并把 对应的 value 拼接到 where 字符串中，最后用于更新时的 where 条件。同时对更新的值按 sql 的 SET 语句格式拼接为 `“key1=value1，key2=value2...”` 的格式。然后添加到 sql 语句中进行执行，最后返回一个json格式的信息：

<div align=center><img src=image-6.png></div><hr>

<font color=#39a3d1 size=6 face='黑体' strong=true>*3.delete*</font><br>
&ensp; &ensp; &ensp;Delete 方法与 update 大致相同，除了对 sql 语句进行改变，以及多加了一个从 url 中读入要删除的元组的主键值外，其余部分的数据处理与 update 近乎相同：

<div align=center><img src=image-7.png></div><hr>

<font color=#39a3d1 size=6 face='黑体' strong=true>*4.select*</font><br>
&ensp; &ensp; &ensp;select 方法的实现较为复杂，需要处理两种情况：<br>
<font color=#ac1f6b  size=5>*(1).带 id 的查询*</font><br>
&ensp; &ensp; &ensp;通过从 url 中获取主键属性（直接从方法的参数中获得），直接编写 where 子句，遇到多列为主键的表时进行处理，将筛选语句用 `and` 进行连接，随后获取到数据后，转化为字符串（使得返回的数据更加直接，避免出现形如 `datetime.date()` 的语句，转化为直接的时间输出），再转化为 json 文件后返回。
<div align=center><img src=image-9.png></div><hr>

<font color=#ac1f6b  size=5>*(2).带筛选条件 `?query` 的查询*</font><br>
&ensp; &ensp; &ensp;分情况讨论，带筛选条件或不带筛选条件的情况。通过 `request.args` 获取到要进行筛选的条件，并分别存储到 `filter_column, filter_value` 中，随后像前面一样形成 sql 语句随后查询，返回一个 json 文件。
<div align=center><img src=image-10.png></div><hr>